# Troubleshooting

### Users are immediately removed from organizations / can't see contracts they should be in

__**Problem:**__
- When a learner logs in and goes to their dashboard in Learn, they are not able to see one (or more) organizations they belong to.
- Or, they're able to see the organization but they're missing some contracts/courses.

__**Probable Cause A:**__ The learner's organization membership is incorrect in Keycloak for some reason. Typically, this happens because the user is in an org that has an IDP integration set up, but their account has a password. When this happens, the user won't automatically be put into the org. (This can happen if the learner had an account _before_ we set up the org or IDP integration, or if the learner has managed to get around the IDP integration.)

__**Diagnosis and Repair A:**__

1. Determine what organizations the learner should be in. For example, if the learner is using an email address ending in `@mit.edu`, they should at least be in the MIT org.
    > If the learner's not supposed to be in the org, then there's nothing to do and you can stop.
2. Check to see if any of the missing orgs are Keycloak-controlled. If the org is Keycloak-controlled, it will have an SSO ID.
3. If they are Keycloak-controlled:
    1. Make sure the SSO ID is correct. The SSO ID is a UUID that is generated by Keycloak, and you can get that from the Keycloak realm admin. There is documentation elsewhere describing the process. If the ID is incorrect, replace it with the correct one.
    2. Check the learner's Keycloak credentials:
        1. Check if the Keycloak org has an identity provider configuration.
        2. If it does, then check to see if the learner has a password set. This can be done from within the Keycloak realm admin by opening the user and going to the Credentials tab. If the user's managed to set a password, it will be listed there; delete it.
    3. Check the learner's Keycloak organization membership:
        1. From the Keycloak realm admin, you can open the user's record and go to the Organizations tab. This will show you all the orgs the learner is in.
        2. If they're not in the correct org, you may be able to add them. If the org _does not_ have an IDP setup, you can click "Join organization", then select "Join organization", and then check the box for the relevant organization. If the org _does_ have an IDP setup, leave it alone - the learner should be added to the org automatically when they log in next.
    4. If you need to quickly or immediately resolve the issue, and you've ensured they're supposed to be in a given contract/org, you can manually add them via the Django Admin. There are instructions for this elsewhere.
4. If they are not Keycloak-controlled: You can add them to the contract and org manually. See the documetation for that elsewhere.
5. _In either case:_ for the fix to take full effect, the learner must log _out_ of Learn/MITx Online and log back in again. Otherwise, the middleware won't know that the learner's organization membership has been updated and won't know to reconcile their orgs and contracts.

__**Probable Cause B:**__ If the learner is added to the org, but immediately removed, the org membership record in MITx Online may not have been set up correctly.

__**Diagnosis B:**__ This will generally only happen if the contract is a _managed_ type (_SSO_ in the former parlance) or if the organization is a Keycloak-controlled org to which the learner was manually added.

If this is the case, you should follow the same steps as above to ensure the learner is in the org within Keycloak and add them if appropriate. Make sure you have the "Keep Until Seen" flag turned _ON_. If it's not set, the system will think the learner isn't supposed to be in the org (because their Keycloak org list won't have the org in it) and will remove them.

Again, the learner should log _out_ of Learn/MITx Online and back in for the fix to fully take effect.

### Learners can't redeem an enrollment code through Learn

__**Problem:**__ Learners can't use an enrollment code they've been provided through Learn - with a URL like `https://learn.mit.edu/enrollmentcode/<code>`. They may see a generic error message, and they may not see the contract that they're in.

__**Probable Cause:**__ The code is invalid. Codes can become invalid in a few ways:
- Typo: enrollment codes are UUIDs so if someone is literally typing them in, they may mistype part of the code.
- Expiration: enrollment codes can optionally expire after a set time. Additionally, the contract may have expired, or the organization can be deactivated.
   - Similarly, codes may not _become active_ until a set date either.
- Use: if an enrollment code has been used by someone, it is (typically, but not always) consumed and can't be used by another learner. Or, if the contract has a set number of seats, and that limit has been hit, the system won't allow the code to be redeemed.
- Other system error: if there's something else going on, the system may not be able to process enrollment codes.

__**Diagnosis:**__
1. Make sure the code itself is correct. You can either get a list of the codes for the contract they're trying to get into, or find the enrollment code itself in the Django Admin or Staff Dashboard (as these are actually discount codes).
2. Make sure the code hasn't expired. If the contract has a start/end date, the code should also have these dates. If it does, and the date of redemption doesn't fall between the dates listed, then the learner should not be granted access to the contract.
   - If the contract start/end dates have been changed, the dates on the enrollment codes should have also been updated. But if they haven't, you can fix the dates on the codes.
3. Make sure the contract and organization are active. As noted, the contracts have optional start/end dates. They can also be made "active" - the active flag supersedes the activation dates. Additionally, the org it belongs to has an active flag; if it's inactive, none of the contracts it has are active, either.
4. Make sure the contract isn't full. Many of our UAI contracts don't have a set seat count, but the B2B ones do; make sure the contract isn't full for some reason, because that will stop code redemption. You can add seats - but make sure this is allowed; you will need to clear this with the appropriate contacts in OL, especially for a B2B contract.
5. Make sure the code hasn't been used. Usually, the enrollment codes will be one-time use; if the code has been redeemed, it can't be reused.
6. Check for system errors. If the system is having issues, there should be logs in Sentry and appropriate action should be taken.
